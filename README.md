# Спецархив

> 🚧 🚧 🚧 WORK IN PROGRESS 🚧 🚧 🚧
>
> Скрипты в процессе разработки.
> Многое пока не работает.

## Об архиве

### Основные принципы

Архив содержит _снимки_ (📸) и _аннотации_ (🏷) для публично доступных веб-страниц (🌐 адресов в интернете).

```txt
🌐 адрес 1            🌐 адрес 2          🌐 адрес 3      ...       🌐 адрес N
📸 📸 📸 📸            📸 📸                                         📸 📸 📸 📸 📸 📸
🏷                                        🏷                        🏷
```

📸 **Снимок веб-страницы** — это копия того, что выдавал сервер в конкретный момент времени.
Каждому адресу веб-страницы может соответствовать несколько снимков.
Они отличаются как временем, так и способом получения.
Снимки бывают локальными (созданные волонтёром у себя на компьютере) и внешними (созданные сторонними сервисами).

Локальные снимки более гибкие и содержательные, потому что мы сами управляем инструментами для их создания.
Внешние снимки содержат меньше информации, но считаются более надёжными.
Чисто в теории локальные снимки могут быть подделкой, поэтому использование внешних сервисов — это что-то вроде получения нотариально заверенных копий.
Даже если весь наш архив с данными уничтожить, внешние снимки веб-страниц всё равно доживут до потомков.

🏷 **Аннотация веб-страницы** — это дополнительные данные, которые были добавлены человеком или скриптами в процессе архивации.
Пример аннотаций — метки (теги).
Они помогают собирать, структурировать и анализировать архивные данные, при этом хранятся отдельно от снимков страниц.

> ℹ️  
> На данном этапе архивация доступна только для сообществ ВК: лент и постов с комментариями.
> Архитектура архива позволяет работать с другими источниками веб-страниц в будущем.

### Структура архива

Содержимое архива разделено на коллекции.
Каждая коллекция архива фокусируется на чём-то одном: например, _сообществах ВК в Энской области_.
Разделение архива на коллекции упрощает параллельный сбор данных, а также их хранение и анализ.

```txt
🌐 🌐 🌐 🌐            🌐 🌐 🌐 🌐 🌐         🌐 🌐 🌐                   🌐 🌐 🌐
🗃 коллекция 1        🗃 коллекция 2        🗃 коллекция 3    ...     🗃 коллекция N
↕                     ↕                     ↕                        ↕
👤                    👤👤👤                 👤                        👤👤
```

Коллекция архива — это обычная папка с файлами.
Мы не используем базы данных или закрытые форматы файлов, чтобы минимизировать зависимость архива от технологий для обработки данных.
Ключевые форматы файлов в коллекции — [JSON](https://ru.wikipedia.org/wiki/JSON) и [ZIP](https://ru.wikipedia.org/wiki/ZIP).

Для обмена собранными данными мы используем [гит](https://ru.wikipedia.org/wiki/Git) (систему контроля версий).
Это упрощает совместную работу над коллекциями архива и помогает делать резервные копии данных в процессе их сбора.
Система контроля версий не является обязательным компонентом для исследователей архива.

Код в этом репозитории не является частью архива.
Собранные данные не теряют ценность в случае утери или поломки скриптов.

### Структура коллекции архива

🗃 папка с коллекцией архива  
🌐 папка с архивом одной веб-страницы (адреса в интернете)  
📸 папка cо снимками одной веб-страницы  
📂 любая другая папка

🏛 файл с первичными данными (включен в коллекцию)  
⏳ временный файл (не включен в коллекцию)  
🛠 технический файл (включен в коллекцию, но не имеет исторической ценности)

Все файлы и папки опциональные: они создаются в процессе запуска скриптов.
Если вы что-то пока не видите в своей коллекции, ничего страшного.

```txt
🗃 [collection-path]/

  📂 snapshot-queues/

    ⏳ some-external-generator.json
    ⏳ some-internal-generator.json
    ⏳ some-other-external-generator.json


  📂 web-pages/

    📂 vk/

      📂 accounts/

        🌐 id12345/
        🌐 club54321/
        🌐 typical_ensk/


      📂 posts/

        📂 -54321/

          🌐 111/
          🌐 222/
          🌐 333/

        📂 12345/

          🌐 444/
          🌐 555/
          🌐 666/


  🛠 .gitattributes
  🛠 .gitignore
  🛠 README.md
  ⏳ url-inbox.txt
```

Папка `📂 web-pages` содержит данные по веб-страницам коллекции.
Структура этой папки определяется форматом интернет-адресов.
Например, `https://vk.com/wall-54321_111` соответствует папке `🌐 web-pages/vk/posts/-54321/111`.

Папка `📂 snapshot-queues` используется при [создании и обновлении снимков](#создание-и-обновление-снимков).
Файл `⏳ url-inbox.txt` нужен [для регистрации адресов веб-страниц](#регистрация-веб-страниц-списком).

Папка каждой веб-страницы имеет такую структуру:

```txt
🌐 some/path/to/web-page/

  📸 snapshots/

    🏛 2022-03-10-011223z-some-internal-generator.zip
    ⏳ 2022-03-10-011223z-some-internal-generator.zip.summary.json

    ⏳ 2022-04-05-124312z-some-external-generator.zip
    ⏳ 2022-04-05-124312z-some-external-generator.zip.summary.json

    ⏳ 2022-04-27-071231z-some-other-external-generator.zip
    ⏳ 2022-04-27-071231z-some-other-external-generator.zip.summary.json

    🏛 2022-05-02-182048z-some-internal-generator.zip
    ⏳ 2022-05-02-182048z-some-internal-generator.zip.summary.json

    ⏳ 2022-05-02-182440z-some-external-generator.zip
    ⏳ 2022-05-02-182440z-some-external-generator.zip.summary.json


  ⏳ snapshot-summary-combination.json
  🏛 web-page.json
```

В файле `🏛 web-page.json` хранится адрес веб-страницы, списки известных снимков (📸) и аннотация (🏷).
Это единственный обязательный файл в папке.

Папка `📸 snapshots` предназначена для снимков веб-страницы.
Локальные снимки содержат первичные данные и поэтому становятся частью коллекции (🏛).
Внешние снимки — это временные файлы (⏳), так как их всегда можно скачать заново.

<!-- ↑ Возможно, это допущение будет пересмотрено. -->

Рядом со снимком веб-страницы находится сводка по этому снимку: `⏳ *.summary.json`.
Сводки [извлекаются из снимков скриптами](#извлечение-сводок-из-снимков) и содержат структурированные копии веб-страниц (например, список постов в ленте сообщества).
Файлы сводок считаются временными, потому что в них есть только данные из снимков.
Файл `⏳ snapshot-summary-combination.json` тоже генерируется локально и содержит комбинацию сводок (например, объединённый список постов за всё время архивации сообщества).

Временны́е координаты в названиях файлов (`2022-04-05-124312z`) и внутри документов (`"2022-04-05T12:43:12Z"`) используют часовой пояс [UTC](https://ru.wikipedia.org/wiki/%D0%92%D1%81%D0%B5%D0%BC%D0%B8%D1%80%D0%BD%D0%BE%D0%B5_%D0%BA%D0%BE%D0%BE%D1%80%D0%B4%D0%B8%D0%BD%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%BD%D0%BE%D0%B5_%D0%B2%D1%80%D0%B5%D0%BC%D1%8F) (MSK-03).
[Согласно ISO 8601](<https://en.wikipedia.org/wiki/ISO_8601#Coordinated_Universal_Time_(UTC)>), UTC обозначается литерой `Z` _(“Zulu time”)_.
Мы не убираем этот символ, чтобы не создавать путаницы с местным временем или временем по Москве.

---

Разбивка папки `📂 web-pages` на подпапки помогает упорядочить коллекцию, но не несёт в себе дополнительной информации.
Любая подпапка с файлом `🏛 web-page.json` считается папкой веб-страницы (🌐).
Вложенных папок веб-страниц быть не должно:

```txt
🌐 some/path/to/web-page/
  🏛 web-page.json


❌ some/path/to/web-page/some/subfolder/
  ❌ web-page.json
```

## Инструкции

Чтобы собрать коллекцию архива, вам понадобятся:

- базовое понимание [командной строки](https://ru.wikipedia.org/wiki/Интерфейс_командной_строки) (терминала),
- небольшой опыт работы с [гитом](https://ru.wikipedia.org/wiki/Git) (системой контроля версий),
- поверхностное знакомство с форматом [JSON](https://ru.wikipedia.org/wiki/JSON).

В качестве текстового редактора рекомендуется [VSCode](https://code.visualstudio.com) с расширениями
[DotENV](https://marketplace.visualstudio.com/items?itemName=mikestead.dotenv),
[Git Graph](https://marketplace.visualstudio.com/items?itemName=mhutchie.git-graph),
[Git Lens](https://marketplace.visualstudio.com/items?itemName=eamodio.gitlens) и
[Yaml](https://marketplace.visualstudio.com/items?itemName=redhat.vscode-yaml).

В упоминаемых папках и файлах `[project-path]` условно обозначает локальную папку, которую вы выделили под проект.
Например, если на вашем компьютере это `/Users/me/projects/special-internet-archive`, то `[project-path]/some-folder` в инструкциях означает `/Users/me/projects/special-internet-archive/some-folder`.

### Требования к системе

Для запуска скриптов подойдёт любой относительно современный компьютер с любой операционной системой (Linux, macOS, Windows).
Хватит 4-8 ГБ оперативной памяти и порядка 2-5 ГБ свободного места на диске.

### Подготовка к работе

Эти шаги достаточно выполнить один раз, даже если вы планируете сбор нескольких коллекций архива.

1.  Убедитесь, что на машине установлены [гит](https://git-scm.com) (система контроля версий), [гит-лфс](https://git-lfs.github.com) (плагин для работы с большими файлами) и [нода](https://nodejs.org/ru) (среда запуска скриптов).
    При установке ноды рекомендуется выбрать версию LTS.

    Команды для проверки установки:

    ```sh
    git --version
    ## покажет ≥ 2.30
    
    git-lfs --version
    ## покажет ≥ 3.0
    
    node --version
    ## покажет ≥ 16.0, < 17
    ```

1.  Установите последнюю версию [ярна](https://yarnpkg.com) (менеджера зависимостей):

    ```sh
    npm install --global yarn
    ```

    Команда для проверки установки:

    ```sh
    yarn --version
    ## покажет ≥ 1.22
    ```

1.  [Клонируйте](https://docs.github.com/en/github/creating-cloning-and-archiving-repositories/cloning-a-repository) этот репозиторий в папку `[project-path]/tooling`.

    Если результат оказался в другой папке, например, `[project-path]/special-archive-tooling` или `[project-path]/archive/tooling`, то папку можно перенести.
    Связь с гитхабом при этом не потеряется.
    В качестве самопроверки убедитесь, что на вашем компьютере существует файл `[project-path]/tooling/README.md`.

    Про `[project-path]` написано выше.

1.  Откройте терминал, перейдите в папку `[project-path]/tooling`:

    ```sh
    cd "[project-path]/tooling"
    ```

    Название этой папки должно появиться слева от места ввода команды.

1.  Будучи в папке `[project-path]/tooling`, установите зависимые библиотеки:

    ```sh
    yarn install
    ```

    Это займёт пару минут.

1.  Будучи в папке `[project-path]/tooling`, создайте пустой файл `.env.local`:

    ```sh
    yarn exe scripts/ensure-dot-env-local.script.ts
    ```

    Запуск этой консольной команды помогает проверить общую работоспособность скриптов.
    Если возникла ошибка, следует заново пройтись по инструкции (видимо, что-то пропустили).

### Настройка коллекции архива

Перед выполнением шагов в этом разделе вам надо получить доступ к непубличному репозиторию с данными.
Для этого свяжитесь с автором скриптов или кем-то из телеграм-чата [@ruarxivechat](https://t.me/ruarxivechat).
Вы должны быть зарегистрированным пользователем на гитхабе и сообщить свой ник.

После получения доступа:

1.  Создайте локальную папку `[project-path]/data/collections`.

1.  Клонируйте созданную для вас ветку в папку `🗃 [project-path]/data/collections/[collection-id]`.

    `[collection-id]` — это название коллекции (например, `region-ru-pnz` или `topic-xyz`).
    Название папки соответствует названию ветки репозитория с данными (`collections/[collection-id]`).

1.  Откройте файл `[project-path]/tooling/.env.local` как текстовый и укажите путь к коллекции архива.
    Это делается добавлением такой строчки:

    ```ini
    COLLECTION_DIR_PATH=[project-path]/data/collections/[collection-id]
    ```

    Части `[project-path]` и `[collection-id]` надо заменить на настоящие.

<!--

1.  Если коллекция архива новая (то есть ещё не начата кем-то другим), заполните файл `[project-path]/data/collections/[collection-id]/collection-config.yml`.
    Шаблон этого файла уже будет создан до вас.
    Внутри — комментарии с подсказками.

    ```yml
    name: Энская область
    description: Популярные паблики Энской области в ВК
    timeZone: MSK+2
    ```

    Указанный часовой пояс будет использоваться браузером во время скачивания всех веб-страниц.
    Примеры [часовых поясов России](https://ru.wikipedia.org/wiki/%D0%92%D1%80%D0%B5%D0%BC%D1%8F_%D0%B2_%D0%A0%D0%BE%D1%81%D1%81%D0%B8%D0%B8): `MSK` (Московское время), `MSK-1` (Калининград), `MSK+9` (Камчатка).
    Часовой пояс влияет на время, которое показывает сервер при получении снимков веб-страниц.

1.  Закоммитьте и запушьте изменения в файле `collection-config.yml` при помощи гита.

    Этот шаг упростит дальнейшую работу над вашей коллекцией архива и обеспечит вас резервной копией.

-->

### Регистрация веб-страниц в коллекции

Чтобы начать делать снимки, необходимо добавить в коллекцию архива первые несколько ссылок на веб-страницы.
Пока что это могут быть только сообщества ВК (`https://vk.com/typical_ensk`).
или прямые ссылки на посты (`https://vk.com/wall-123-456`).
Ссылки на посты регистрировать не обязательно, так как они автоматически извлекаются из лент зарегистрированных сообществ.

Регистрировать новые ссылки в коллекцию архива можно в любой момент.
Желательно держать коллекцию сфокусированной на чём-то одном, то есть не сваливать все ссылки в кучу.
Это упростит координацию сбора данных и их анализ.

Зарегистрировать новые веб-страницы в коллекцию архива можно списком или по одной.
Повторные попытки зарегистрировать одну и ту же ссылку будут проигнорированы.
Уже собранные данные при этом не потеряются.

#### Регистрация веб-страниц списком

1.  Создайте файл `⏳ [collection-path]/url-inbox.txt`.
    Это можно сделать вручную или скриптом:

    ```sh
    yarn exe scripts/web-pages/ensure-url-inbox.script.ts
    ```

1.  Накидайте в файл `⏳ url-inbox.txt` ссылки, которые хотите зарегистрировать.
    Каждая строчка в файле должна содержать только одну ссылку.
    Пустые строчки или строчки без ссылок проигнорируются.
    Если вы копируете ссылки из таблицы, вам не придётся ничего менять.

    Пример:

    ```txt
    https://vk.com/id123

    https://vk.com/group123
    https://vk.com/public123
    https://vk.com/something
    какой-то текст между ссылками
    https://vk.com/wall-123-456
    ```

1.  Запустите скрипт для регистрации всех ссылок из файла `⏳ url-inbox.txt`:

    ```sh
    yarn exe scripts/web-pages/register-from-url-inbox.script.ts
    ```

    Это создаст файлы `🏛 [collection-path]/web-pages/**/web-page.json`.

1.  ![][опционально]  
    Запустите скрипт, который удалит все зарегистрированные ссылки из файла `⏳ url-inbox.txt`.
    Это поможет разглядеть ссылки, которые не получилось добавить.

    ```sh
    yarn exe scripts/web-pages/clean-up-url-inbox.script.ts
    ```

    Пример:

    ```txt
    https://vk.com/public123
    https://vk.com/unsupported/url
    какой-то текст между ссылками
    https://vk.com/group123

    https://vk.com/wall-123-456
    ещё текст
    https://unsupported.example.com
    ```

    ↓

    ```txt
    https://vk.com/unsupported/url
    какой-то текст между ссылками

    ещё текст
    https://unsupported.example.com
    ```

#### Регистрация веб-страниц по одной

1.  Введите адрес, который хотите зарегистрировать в коллекции архива:

    ```sh
    ## cmd.exe
    set URL_TO_REGISTER=https://vk.com/typical_ensk
    
    ## любой другой терминал
    export URL_TO_REGISTER=https://vk.com/typical_ensk
    ```

1.  Запустите скрипт для регистрации этой веб-страницы:

    ```sh
    yarn exe scripts/web-pages/register-from-env.script.ts
    ```

    Повторите эти шаги для каждой веб-страницы, которую хотите зарегистрировать.

### Создание и обновление снимков

Сбор новых снимков состоит из трёх действий: инвентаризация существующих снимков, составление очереди заявок на новые снимки и исполнение очереди.

#### Локальные снимки: Playwright

[Playwright](https://playwright.dev) — инструмент для тестирования веб-приложений.
По сути это обёртка вокруг веб-браузера, которая позволяет автоматизировать взаимодействие с сайтами.
Программа может открывать веб-страницы, нажимать на ссылки и кнопки, проматывать содержимое, вводить текст и так далее.
Playwright умеет сохранять такие автоматизированные сессии в виде очень детализированных отпечатков (traces).
Отпечаток Playwright — это что-то вроде слайдов в презентации, только в формате `zip`.
Внутри архива находятся все необходимые ресурсы для отображения «слайдов»: разметка, стили и картинки.
Каждый «слайд» соответствует одному действию (например, прокрутка веб-страницы вниз).

Программа Playwright имеет открытый исходный код и свободную лицензию.
Формат отпечатков тоже открыт и поэтому без проблем прочитается в будущем.
Пример отпечатка веб-страницы в Playwright [доступен на сайте проекта](https://trace.playwright.dev/?trace=https://demo.playwright.dev/reports/todomvc/data/cb0fa77ebd9487a5c899f3ae65a7ffdbac681182.zip).

Для тестировщиков веб-приложений отпечатки Playwright — это средство отладки кода.
Для нас отпечатки Playwright — это возможность сделать компактные, но содержательные локальные снимки веб-страниц.

1.  Проведите инвентаризацию существующих снимков Playwright:

    ```sh
    yarn exe scripts/web-pages/snapshots/playwright/1-update-inventory.script.ts
    ```

1.  Составьте очередь заявок на новые снимки:

    ```sh
    yarn exe scripts/web-pages/snapshots/playwright/2-compose-queue.script.ts
    ```

    Этот скрипт пройдётся по коллекции веб-страниц и посмотрит на время последних известных нам снимков в Playwright.
    Веб-страницы, которые давно не загружались, будут добавлены в очередь.
    Интервал между запрашиваемыми снимками зависит от типа и возраста конкретной веб-страницы.
    Настроить его пока что нельзя.

1.  Обработайте очередь заявок на новые снимки:

    ```sh
    ## 🔬 🔬 🔬 работает в экспериментальном режиме 🔬 🔬 🔬
    yarn exe scripts/web-pages/snapshots/playwright/3-process-queue.script.ts
    ```

    Обработку очереди можно прерывать и перезапускать.
    Успешные заявки обрабатываться по второму разу не будут.

#### Внешние снимки: Wayback Machine

[Wayback Machine](https://ru.wikipedia.org/wiki/Wayback_Machine) — это некоммерческий онлайн-архив интернета.
Он [заблокирован в России](https://ru.wikipedia.org/wiki/Wayback_Machine#%D0%91%D0%BB%D0%BE%D0%BA%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B8), поэтому для работы со снимками в этом хранилище [вам понадобится VPN](https://roskomsvoboda.org/cards/card/whydoyouneedVPN/).

[web.archive.org](https://web.archive.org) пока что выступает в роли единственного внешнего хранилища.
Возможно, в будущем мы подключим и другой онлайн-архив: [archive.ph](https://archive.ph).
Комбинирование хранилищ повышает надёжность и полноту архива.

1.  Проведите инвентаризацию существующих снимков Wayback Machine:

    ```sh
    yarn exe scripts/web-pages/snapshots/wayback-machine/1-update-inventory.script.ts
    ```

    Этот скрипт скачает список уже существующих снимков для веб-страниц из нашей коллекции.
    Среди них могут быть как снимки, которые мы запрашивали ранее, так и снимки, которые делал кто-то другой.

    Повторный запуск команды пропустит веб-страницы, которые проверяли до 5 минут назад.
    Этот интервал контролируется переменной окружения `INVENTORY_UPDATE_INTERVAL_IN_MINUTES`.

1.  Составьте очередь заявок на новые снимки:

    ```sh
    yarn exe scripts/web-pages/snapshots/wayback-machine/2-compose-queue.script.ts
    ```

    Этот скрипт пройдётся по коллекции веб-страниц и посмотрит на время последних известных нам снимков в Wayback Machine.
    Веб-страницы, которые давно не загружались, будут добавлены в очередь.
    Интервал между запрашиваемыми снимками зависит от типа и возраста конкретной веб-страницы.
    Настроить его пока что нельзя.

1.  Обработайте очередь заявок на новые снимки:

    ```sh
    yarn exe scripts/web-pages/snapshots/wayback-machine/3-process-queue.script.ts
    ```

    Скрипт посмотрит на адреса веб-страниц в очереди и отправит каждую из них через форму https://web.archive.org/save.

    Обработку очереди можно прерывать и перезапускать.
    Успешные заявки обрабатываться по второму разу не будут.

### Извлечение сводок из снимков

Снимки веб-страниц содержат «сырые» данные: разметку, стили и картинки.
Мы заранее не знаем, что из этого ценно, поэтому разделяем получение данных и их обработку.

Чтобы автоматизировать архивацию постов ВК, нам нужно «прочитать» ленты сообществ и найти в них ссылки типа `https://vk.com/wall-123-456`.
Сначала мы разбираем известные нам снимки и извлекаем сводку по каждому из них.
Так как у каждой веб-страницы может быть по несколько снимков, мы комбинируем полученные сводки отдельным скриптом.

#### Локальные снимки: Playwright

1.  Проведите инвентаризацию существующих снимков:

    ```sh
    yarn exe scripts/web-pages/snapshots/playwright/4-update-inventory.script.ts
    ```

1.  Извлеките сводки из снимков:

    ```sh
    ## 🔬 🔬 🔬 работает в экспериментальном режиме 🔬 🔬 🔬
    yarn exe scripts/web-pages/snapshots/playwright/5-extract-summaries.script.ts
    ```

    Этот скрипт создаст файл `⏳ [web-page-path]/snapshots/*-playwright.zip.summary.json` для каждого файла `🏛 [web-page-path]/snapshots/*-playwright.zip`.

#### Внешние снимки: Wayback Machine

1.  Проведите инвентаризацию существующих снимков.
    Сервису [web.archive.org](https://web.archive.org) нужно время для создания новых снимков, поэтому желательно подождать минут 10-30 с момента отправки заявок.

    ```sh
    yarn exe scripts/web-pages/snapshots/wayback-machine/4-update-inventory.script.ts
    ```

1.  Извлеките сводки из снимков:

    ```sh
    ## 🚧 🚧 🚧 пока не работает 🚧 🚧 🚧
    yarn exe scripts/web-pages/snapshots/wayback-machine/5-extract-summaries.script.ts
    ```

    Этот скрипт скачает известные нам снимки из [web.archive.org](https://web.archive.org) в `⏳ [web-page-path]/snapshots/*-wayback-machine.zip` и создаст файл `⏳ [web-page-path]/snapshots/*-wayback-machine.zip.summary.json` для каждого снимка.

#### Комбинация сводок

```sh
## 🚧 🚧 🚧 пока не работает 🚧 🚧 🚧
yarn exe scripts/web-pages/snapshots/extract-summary-combinations.script.ts
```

Этот скрипт прочитает файлы `⏳ [web-page-path]/snapshots/*.summary.json`, скомбинирует данные и сохранит результат в файл `⏳ [web-page-path]/snapshot-summary-combination.json`.

### Аннотация веб-страниц

1.  TODO

    ```sh
    ## 🚧 🚧 🚧 пока не работает 🚧 🚧 🚧
    yarn exe scripts/web-pages/annotations/extract-from-snapshot-summary-combinations.script.ts
    ```

### Авторегистрация новых веб-страниц на основе аннотаций

1.  TODO

    ```sh
    ## 🚧 🚧 🚧 пока не работает 🚧 🚧 🚧
    yarn exe scripts/web-pages/register-from-annotations.script.ts
    ```

[опционально]: https://img.shields.io/badge/-опционально-white.svg
